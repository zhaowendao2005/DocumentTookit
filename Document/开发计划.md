boss，我把你的新要求整理为可落地的最小可用版本方案，包含：实现计划、架构设计、总工作流、文件架构与配置、交互改动，以及“运行总结报告系统”的设计。按你的时间窗口（5小时）可分阶段完成。

### 目标与边界
- 在批处理交互中新增“输出模式”选择：
  - 经典模式：沿用当前提示词让 LLM 直接输出 CSV。
  - 结构化模式：LLM 输出 rows JSON → 本地转 CSV → 走现有 CSV 校验与语义一致性工作流。
- 结构化模式失败时（解析/校验多次失败），可按 `env.yaml` 配置回退至经典模式，仅影响该文件。
- prompts 版本化：`prompts@StructuredFileProcessor/` 按版本建目录；交互可选择提示词版本，默认版本由 `env.yaml` 配置。
- 不做 function call/MCP，仅参照其思想以 JSON+Schema+重试 实现。
- 增强“任务完成总结系统”：生成中文、可读性强、既有总览也有细节的报告（程序自动生成）。

### 配置与目录规范
- `config/env.yaml` 新增（示例）：
```yaml
processing:
  default_mode: "structured"       # "classic" | "structured"
  allow_fallback: true             # 结构化失败是否回退经典
  fallback_mode: "classic"         # 失败回退目标

structured:
  prompts_root: "./prompts@StructuredFileProcessor"
  default_prompt_version: "v1.0"   # 交互未选择时的默认版本
  max_repair_attempts: 2           # JSON纠错回合上限（0-3）
  force_json_response: false       # 若provider支持，可强制json模式（可先保留为false）
  schema_path: "./schemas/rows.schema.json"
```

- 提示词目录（版本化）：
```
prompts@StructuredFileProcessor/
  v1.0/
    system.rows.md     # 主提示词：只输出 { rows: [...] } JSON，无任何多余文本/围栏
    repair.rows.md     # 纠错提示词：注入字段级错误清单，要求仅返回修正后的 JSON
  v1.1/
    system.rows.md
    repair.rows.md
```

- Schema 文件：
```
schemas/
  rows.schema.json     # 约束 rows 数组及每行5字段：编号/问题/答案/答题人/专业
```

### 交互改动（UI）
- `modules/ui-interactive.js`
  - 在“批量LLM处理”流程新增“输出模式”选择：Classic / Structured（默认取 `processing.default_mode`）。
  - 若选择 Structured：
    - 列出 `prompts@StructuredFileProcessor/*/` 目录作为“提示词版本”，供选择（默认 `structured.default_prompt_version`）。
    - 可选参数：`structured.max_repair_attempts`（默认来自配置）。
  - 将 `mode`、`promptVersion`、`repairAttempts` 一并回传主流程。

### 顶层流程与模块职责
- 主入口 `main.js`
  - 读取 UI 配置并根据 `mode` 调用对应处理器：
    - 经典：`FileProcessor.runBatch(...)`（保持不变）
    - 结构化：`StructuredFileProcessor.runBatch(...)`
- 新增 `modules/structured-file-processor.js`
  - 对每个输入文件执行：
    1) 构造 messages：使用版本化的 `system.rows.md` + 用户文本
    2) 发送请求（通常 `requestCount=1`）
    3) 解析输出为 JSON → 按 `rows.schema.json` 校验
    4) 若失败：用 `repair.rows.md` 注入字段级错误，触发纠错回合（≤ `max_repair_attempts`）
    5) 仍失败：若 `allow_fallback=true` 则本文件回退到经典模式；否则标记失败
    6) 转 CSV（固定表头、正确转义）→ 写入中间 CSV 文本
    7) 调用现有 `CsvValidator.validateAndFix(...)` → 将修复后的 CSV 文本加入“多样本语义校验”与最终输出逻辑
  - 并发控制、token 记录继续使用现有逻辑
  - 中间产物落盘：
    - `data/temp/<runId>/<relativePath>/sample_<i>.json`（原始JSON）
    - `.../sample_<i>_repaired.json`（修正后JSON）
    - `.../sample_<i>.csv`（转换后CSV文本，进入现有校验流）

- 新增 `modules/json-schema-validator.js`（轻量实现）
  - 基于 `schemas/rows.schema.json` 进行本地字段级校验（类型/范围/必填/最大长度等）
  - 输出 field-level 错误（如 `rows[0].编号` must be integer >= 1）

- 可选 `utils/json-utils.js`
  - 安全解析：去除围栏、修剪 BOM、手动容错替换（如单引号→双引号）后再 JSON.parse
  - 仅在解析失败优先尝试容错，不改变语义

### 总工作流（结构化模式）
- UI 选择 Structured + 提示词版本 vX.Y
- 每个文件的每个样本：
  1) 请求（messages：system.rows.md + fileContent）
  2) 解析→Schema 校验
  3) 若失败：以 `repair.rows.md` + 错误清单纠错；最多 N 次
  4) 成功：`rows` → CSV → `CsvValidator` → 纳入现有“多样本语义校验与投票”
  5) 失败（超过 N 次）：若允许回退则本文件切 Classic；否则标记失败
- 批处理结束 → 合并 CSV（用户确认）→ 生成“运行总结报告”

### 运行总结报告系统（程序性自动生成）
- 新增 `modules/run-summary.js`（或 `utils/run-reporter.js`）
- 输入：本次运行的元数据与统计
  - 总文件数/成功/失败/回退文件数、模式分布
  - 结构化模式：纠错回合分布（0次/1次/2次）、最后成功率、失败原因Top
  - token 用量：来自 `utils/token-counter.js`（总计/按provider/按模型/真实vs估算比例）
  - CSV 校验器：平均置信度、自动修复总数、常见问题Top
  - 语义校验：有效样本数、平均置信度、异常样本数
  - 每文件摘要：输入文件、使用模式、是否回退、样本数、最终选择策略、输出路径、关键指标（校验置信度、异常数）
- 输出两份：
  - 可读版：`data/output/<runId>/run_summary.md`（中文、清晰排版、表格+ASCII进度条/柱状条）
  - 机器版：`data/output/<runId>/run_summary.json`
- 控制台最后打印一段精炼总览并给出报告路径

示例 Markdown 摘要结构（片段）：
```
# 批处理运行总结（<runId>）

## 总览
- 处理文件：总计 128，成功 124，失败 4，回退经典 7
- 模式占比：结构化 85%，经典 15%
- 平均用时：32.5s/文件
- Token 用量（真实/估算）：总 1.23M（真实 78%）

## 结构化模式质量
- 纠错回合分布：0次 72% | 1次 22% | 2次 6%
- 最终成功率：94%
- 常见失败原因Top3：
  1. rows[?].编号 非整数（28次）
  2. rows[?].问题 为空（19次）
  3. JSON 非法（围栏或多余解释）（11次）

## CSV 校验质量
- 平均置信度：0.83
- 自动修复总计：312
- 问题Top3：表头不匹配、字段数不符、引号转义

## 语义一致性
- 有效样本： 平均 2.6/文件
- 平均置信度：0.81
- 异常样本：平均 0.3/文件

## 模型与成本
- Provider/Model 用量：...
- 平均请求次数：Structured 1.1 | Classic 2.3
- 估算成本：输入/输出/总（参考定价）
```

### 文件架构变更（不编码，仅规划）
- 新增：
  - `modules/structured-file-processor.js`
  - `modules/json-schema-validator.js`
  - `modules/run-summary.js`（或 `utils/run-reporter.js`）
  - `schemas/rows.schema.json`
  - `prompts@StructuredFileProcessor/v1.0/system.rows.md`
  - `prompts@StructuredFileProcessor/v1.0/repair.rows.md`
- 变更（小改）：
  - `modules/ui-interactive.js`：输出模式 + 提示词版本选择
  - `config/config-loader.js`：加载并校验新增配置键（非强制，缺省时走默认）
  - `main.js`：根据模式路由处理器
  - 文档：`README.md` 简述新模式与报告文件

### 接入点与兼容性
- 保持与现有 `FileProcessor` 的接口一致（`runBatch` 返回同样的统计结构）
- 结构化模式产出的 CSV 文本进入既有 `CsvValidator` 与 `SemanticValidator`，无需重写下游逻辑
- Fallback 仅对失败文件生效，不影响其他文件与整体任务

### 交付优先级与时间安排（5小时内）
- 1) 结构化模式最小处理器骨架（JSON→CSV→校验→纳入多样本）+ 纠错回合 + 回退逻辑（~2h）
- 2) UI 增项（模式选择 + 版本选择）与配置接入（~1h）
- 3) 提示词与 Schema 骨架（v1.0）与解析容错（~0.5h）
- 4) 运行总结报告生成（md/json）最小可用展示（总览+关键指标+Top问题） （~1h）
- 5) 控制台收尾输出报告路径（~0.5h）

### 验收标准
- 交互可选 Classic/Structured，默认遵循 `env.yaml`
- Structured 下，能解析 rows JSON → CSV，并对失败文件进行回退（按配置）
- 最终输出包含 `run_summary.md` 与 `run_summary.json`，内容包含总览与细节
- 不影响经典模式的现有工作流

- 已梳理：你的新需求与约束（输出模式选择、失败回退、prompts 版本化、快速交付）
- 已输出：实现方案、架构设计、总工作流、目录与配置规范、总结报告设计与验收标准
- 准备就绪：可按此方案逐步落地（先交付最小可用版本，再完善细节）